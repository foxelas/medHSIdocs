\documentclass{foxelas_report}
\usepackage{blindtext}

\usepackage{listings}
\usepackage{color}

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}


\lstset{frame=tb,
  language=Python,
  aboveskip=3mm,
  belowskip=3mm,
  showstringspaces=false,
  columns=flexible,
  basicstyle={\small\ttfamily},
  numbers=none,
  numberstyle=\tiny\color{gray},
  keywordstyle=\color{blue},
  commentstyle=\color{dkgreen},
  stringstyle=\color{mauve},
  breaklines=true,
  breakatwhitespace=true,
  tabsize=3
}


\title{Tutorial in MedHSI}

\begin{document}

\setcounter{page}{1}

\maketitle

\section{Introduction}

\par This repository contains code written in two main languages MATLAB and Python. The structure is as follows. 

\begin{description}
\item [medHSImat] contains the MATLAB code and is mostly used for data preprocessing, machine learning and graph creation.
\item [medHSIpy] contains the python code and is mostly used for deep learning applications. 
\item [conf] contains all the configuration parameters to make the code work.
\item [parameters] contains useful parameters for calculations. 
\end{description}

\section{Setup and Initialization} 
\begin{enumerate}

\item Open text file 'medHSI/conf/config.ini' and update it according to your folder structure. Common items that need update on a new machine are: 

\begin{itemize} 
\item DataDir : the data where .hsm and .h5 files from data collection are saved. 

\item ExecutionDir : the folder where MedHSI is located.

\item ImportDir : the folder where additional import files are located.

\item OutputDir : the folder where output results will be saved. 

\item MatDir : the folder where preprocessed data (.mat files) from the analysis will be saved, the database.

\item ParamDir : delete 

\end{itemize}

\par In this case, 'Database' refers to data collected from the same system, e.g. the calibration system, or the current system in the pathology lab. On the other hand, 'Dataset' refers to a subset of the 'Database', for example 'Dataset = pslRaw' refers only to raw samples excluding fixed samples from the 'psl' Database. 

\par If mat files for a certain dataset are already prepared in MatDir, then you can change 'Dataset' to the target dataset. You don't need to change 'DataDate'. 


\item Copy the files from the supplementary material to the respective folders. You can overwrite previous files. 

\begin{itemize}
\item \textbf{parameters} to folder medHSI/parameters/
\item \textbf{import} to the folder set in config::[ImportDir] of medHSI/conf/config.ini
\end{itemize}


\item Set up MATLAB by installing necessary prerequisite packages. Open MATLAB and naviage to  medHSI/medHSImat/setup/ and follow the instructions in README.md. 

\item From here on the term \textbf{config::[XXX]} will refer to setting with name XXX in the config.ini file. 
\end{enumerate}


\section{medHSImat: for MATLAB}

\subsection{Read a new database}
\begin{enumerate}
\item Convert .hsm files to .h5 using the program for the 2D spectroradiometer. Save them as .h5 files in folder '01-Measurements' inside directory conf::[DataDir]. 


\item Add relevant information in config::[ImportDir]/ \textbf{pslDBDataInfoTable.xlsx} and \textbf{pslDBDiagnosisInfoTable.xlsx}. You can check pslDBDataInfoTable.xlsx for missing samples or misnamed files with the following. 
\begin{lstlisting}
#MATLAB
[flag, fileS] = initUtility.CheckImportData();
\end{lstlisting}

\item Check that the \textbf{Preprocessing.m} function matches your preprocessing scheme. If not, update it. 


\item Read the .h5 files, preprocess and convert to class \textbf{hsi} (\url{https://foxelas.github.io/medHSIdocs/classhsi.html}). The class includes a foreground mask and other information. \\

These conditions read all data that in \textbf{pslDBDataInfoTable.xlsx} are set as 'tissue' and as 'raw', so all unfixed tissue samples. A foreground mask is also extracted. 

\begin{lstlisting}
#MATLAB
contentConditions = {'tissue', true};
readForeground = true;
targetConditions = {'raw', false};
hsiUtility.PrepareDataset('pslRaw', contentConditions, readForeground, targetConditions);
\end{lstlisting}


\item Prepare labels using the LABELME tool. Save them as black and white images in folder '02-Labels' inside directory config::[DataDir]. \\
\\
\textbf{How to make labels with labelme: 
}\begin{itemize}
\item Check  \url{https://github.com/wkentaro/labelme}. It is a python based tool.

\item To install in anaconda run the following in a conda prompt.\\

\begin{lstlisting}
# python3
conda create --name=labelme python=3
source activate labelme
# conda install -c conda-forge pyside2
# conda install pyqt
# pip install pyqt5  \# pyqt5 can be installed via pip on python3
pip install labelme
# or you can install everything by conda command
# conda install labelme -c conda-forge
\end{lstlisting}



* Suggested python version =3.9. 

* You can check the tutorial \url{https://github.com/wkentaro/labelme/tree/main/examples/tutorial}.

* If it fails, check that visual studio c++ is included or that the python version is correct. 


\item Open the GUI by running the following \\
\begin{lstlisting}
# Prompt
labelme  # just open gui
\end{lstlisting}

\item From the GUI, open the directory with the images you want to label. Use the tool to draw polygon masks on the images. Each label is saved as a .JSON file in the same folder. 

* In this case the \underline{target directory will be the snapshots in}\\
\underline{config::[Output]/XXX/00-Snapshots/},\\ where XXX refers to the target dataset.

\item Use commands: \\
Make label: 
\begin{lstlisting}
# Prompt
labelme 001.jpg -O 001.json 
\end{lstlisting}

View label: 
\begin{lstlisting}
labelme_draw_json 001.json
\end{lstlisting}

Export label:
\begin{lstlisting}
# Prompt
labelme_json_to_dataset 001.json -o 001_json
\end{lstlisting}


\item With anaconda make a for loop to prepare label images out of each .JSON file. The produced results will be saved in subfolders in the same directory as the .JSON files. 

\begin{lstlisting}
# Prompt
for %a in (150, 157, 160, 163) do labelme_json_to_dataset %a.json -o %a
\end{lstlisting}

\item Update the database .mat files with the new labels.

\begin{lstlisting}
# MATLAB
init.UpdateLabelInfos(dataset);
\end{lstlisting}

\item Now the dataset is ready. You can read it as a list of hsi and hsiInfo classes.

\begin{lstlisting}
# MATLAB
%% Load the entire dataset as a list of hsi and hsiInfo classes
[hsiList, labelInfoList] = hsiUtility.LoadDataset();
\end{lstlisting}

\item You can also export the dataset as an .h5 structure, split it into patches or resize to a standard size with zero padding.

\begin{lstlisting}
# MATLAB
%% Export an .h5 database of all the preprocessed and labeled data
% After reading, the database is saved in config::[OutputDir]\\config::[Dataset]\\*.h5.
hsiUtility.ExportH5Dataset();

%% Make subdatasets from the original dataset
% Make 32x32 patches
targetDataset = '32';
initUtility.MakeDataset(targetDataset, dataset);


% Make 512x512 padded squares
targetDataset = '512';
initUtility.MakeDataset(targetDataset, dataset);

\end{lstlisting}

You can also prepare data validation folds (Leave-one-out, K-fold, custom) or apply functions individually on each image. 

\item For more information check \\
-\textbf{Tutorial\_ReadDataset.m}\\
-\textbf{Tutorial\_ProcessHSI.m}
\end{itemize}

\end{enumerate}

\section{medHSIpy: for python}

%\pagebreak
%\nocite{*}
\bibliographystyle{apalike}%{ieeetr}
\bibliography{references}

\end{document}
